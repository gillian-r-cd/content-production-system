# 系统修复计划 - 2026-02-01
# 功能：第一性原理驱动的系统修复计划，包含问题分析、测试系统、benchmark和详细todo

---

## 一、问题根因分析

### 问题1: 内涵设计没有内容 (Critical)

**现象**: CoreDesignStage显示"方案1/2/3"但"核心特点"显示"暂无描述"

**根因**: 
- `content_core_producer.py`的`_generate_schemes`返回的数据结构与前端期望不匹配
- AI返回: `{ scheme: "方案一：**「标题」**\n\n1. 方案名称...", index: 0 }`
- 前端期望: `{ name: string, description: string, approach: string }`

**位置**: 
- 后端: `core/modules/content_core_producer.py` L74-158
- 前端: `web/src/components/stages/CoreDesignStage.tsx` L10-22

### 问题2: AI对话是摆设 (Critical)

**现象**: 右侧对话面板只在意图分析阶段追问，之后无法有效交互

**根因**:
- 缺少@引用机制
- 缺少全局Agent能力（根据@引用修改各阶段内容）
- `ChatPanel.tsx`只处理`startWorkflow`和`respond`，缺少针对特定阶段的交互

**位置**:
- `web/src/components/layout/ChatPanel.tsx`
- `api/routes/workflow.py`
- `core/orchestrator.py`

### 问题3: 消费者调研缺少确认按钮和编辑功能 (High)

**现象**: 调研结果无法编辑，确认按钮可能不显示

**根因**:
- `ResearchStage.tsx`的确认按钮判断条件过于严格: `status?.input_prompt?.includes('消费者调研已完成')`
- 缺少编辑功能

**位置**:
- `web/src/components/stages/ResearchStage.tsx`

### 问题4: 消费者调研应该出用户画像(Persona) (Medium)

**现象**: 只显示简单的summary和痛点，没有具体的Persona

**需求**:
- 生成2-3个典型用户画像(Persona)
- 让创作者选择是否加入Simulator
- 系统提示词需要补充生成Simulator的提示词

**位置**:
- `core/modules/consumer_researcher.py`
- `config/prompts/consumer_researcher.md.j2`

---

## 二、测试系统设计

### 测试层次

```
1. 单元测试 (Unit)
   - AI返回数据解析测试
   - 数据结构转换测试

2. 集成测试 (Integration)  
   - API端点测试
   - 前后端数据流测试

3. 端到端测试 (E2E)
   - 完整流程测试: Intent → Research → CoreDesign
   - UI交互测试
```

### 测试用例

#### 测试1: 内涵设计方案数据结构

```yaml
测试名称: test_design_schemes_structure
测试类型: 单元测试
测试目标: 验证design_schemes数据结构正确

输入:
  - AI原始返回的YAML字符串
  
预期输出:
  - schemes[0].name: 非空字符串
  - schemes[0].description: 非空字符串
  - schemes[0].approach: 非空字符串
  - schemes[0].target_scenario: 字符串或null
  - schemes[0].key_features: 数组

验证方法:
  1. 打印AI返回的原始数据
  2. 打印解析后的数据结构
  3. 验证每个字段存在且类型正确
```

#### 测试2: 消费者调研确认按钮

```yaml
测试名称: test_research_confirm_button
测试类型: E2E测试
测试目标: 验证确认按钮正确显示

步骤:
  1. 完成意图分析
  2. 进入消费者调研阶段
  3. 等待调研生成完成
  4. 验证确认按钮显示
  5. 点击确认按钮
  6. 验证进入内涵设计阶段
```

#### 测试3: AI对话@引用功能

```yaml
测试名称: test_chat_mention_system
测试类型: 集成测试
测试目标: 验证@引用功能工作

步骤:
  1. 完成意图分析
  2. 在对话框输入 "@意图分析 修改目标为XXX"
  3. 验证AI理解引用并修改对应内容
  4. 验证编辑区同步更新
```

---

## 三、Benchmark定义

### B1: 内涵设计方案显示

| 指标 | 标准 | 测量方法 |
|------|------|----------|
| 方案名称显示 | 100%非空 | 检查UI显示 |
| 方案描述显示 | 100%非空 | 检查UI显示 |
| 方案详情展开 | 100%可展开 | 点击查看详情 |
| 数据加载时间 | <30s | 计时 |

### B2: 消费者调研交互

| 指标 | 标准 | 测量方法 |
|------|------|----------|
| 确认按钮显示 | 100%显示 | 检查UI |
| 编辑功能可用 | 100%可编辑 | 尝试编辑 |
| Persona数量 | 2-3个 | 计数 |

### B3: AI对话功能

| 指标 | 标准 | 测量方法 |
|------|------|----------|
| @引用触发 | 100%识别 | 输入@测试 |
| 内容同步 | 100%同步 | 检查编辑区 |
| 响应时间 | <60s | 计时 |

---

## 四、详细TODO列表

### Phase 1: 修复内涵设计方案显示 (Critical)

- [ ] **1.1** 修改`content_core_producer.py`的`_generate_schemes`方法
  - 改进YAML prompt，确保AI返回正确的字段结构
  - 添加数据结构验证和转换逻辑
  - 添加fallback解析逻辑（处理AI返回不规范的情况）

- [ ] **1.2** 修改`CoreDesignStage.tsx`
  - 添加数据结构兼容处理
  - 如果scheme是长字符串，尝试解析提取name/description

- [ ] **1.3** 测试验证
  - 新建项目，完成Intent→Research→CoreDesign流程
  - 验证方案卡片显示完整信息

### Phase 2: 修复消费者调研确认和编辑 (High)

- [ ] **2.1** 修改`ResearchStage.tsx`
  - 移除严格的确认按钮判断条件
  - 添加编辑功能UI
  - 添加"添加用户画像到Simulator"按钮

- [ ] **2.2** 修改`consumer_researcher.py`
  - 更新prompt，要求生成2-3个具体的Persona
  - 每个Persona包含：姓名、职位、背景、痛点、期望

- [ ] **2.3** 修改`config/prompts/consumer_researcher.md.j2`
  - 添加Persona生成的详细prompt

- [ ] **2.4** 测试验证
  - 验证确认按钮始终显示
  - 验证Persona数据正确生成和显示

### Phase 3: 实现AI对话@引用功能 (Critical)

- [ ] **3.1** 设计@引用语法和解析逻辑
  - 支持: @意图分析, @消费者调研, @内涵.字段名
  - 在ChatPanel中实现@触发和自动补全

- [ ] **3.2** 后端实现@引用处理
  - 在`api/routes/workflow.py`添加处理@引用的逻辑
  - 解析@引用，注入对应上下文到AI请求

- [ ] **3.3** 实现内容修改同步
  - AI返回修改建议后，更新对应阶段数据
  - 通知前端刷新编辑区

- [ ] **3.4** 前端实现
  - ChatPanel添加@触发检测
  - 显示可引用的上下文列表
  - 实现自动补全

- [ ] **3.5** 测试验证
  - 测试@意图分析 引用
  - 测试@消费者调研 引用
  - 测试修改后编辑区同步

### Phase 4: 添加Simulator用户画像 (Medium)

- [ ] **4.1** 设计Simulator提示词模板
  - 在设置中添加Simulator提示词配置
  - 支持多个Simulator配置

- [ ] **4.2** 实现Persona选择加入Simulator
  - 在ResearchStage添加选择UI
  - 保存选中的Persona到项目配置

---

## 五、执行顺序

```
Day 1 (今天):
  1. Phase 1: 修复内涵设计方案显示 (2-3h)
  2. Phase 2: 修复消费者调研确认和编辑 (1-2h)
  
Day 2:
  3. Phase 3: 实现AI对话@引用功能 (3-4h)
  4. Phase 4: 添加Simulator用户画像 (1-2h)
```

---

## 六、验收标准

### 最终验收

1. **内涵设计**: 3个方案全部显示完整信息（名称、描述、详情可展开）
2. **消费者调研**: 确认按钮始终可见，内容可编辑，显示2-3个Persona
3. **AI对话**: 支持@引用，修改后编辑区自动同步
4. **完整流程**: Intent→Research→CoreDesign 可以顺利完成



