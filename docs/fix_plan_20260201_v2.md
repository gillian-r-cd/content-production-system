# 修复计划 2026-02-01 V2

## 问题分析

### 问题0：AI对话和方案选择无法工作（404错误）
**根因**：`/workflow/{id}/select-scheme` 端点不存在
**解决**：添加该端点

### 问题1：调试日志没有内容
**根因**：AI调用时未设置 `current_project_id` 和 `current_stage`
**解决**：在每个模块调用AI前设置上下文

### 问题2：内涵设计界面需要重新设计
**需求**：左边方案目录，右边整屏展开，可编辑
**解决**：重写 `CoreDesignStage.tsx` 为左右布局

### 问题3：所有AI生成字段需要可编辑
**范围**：
- 意图分析：goal, content_type, target_audience 等
- 消费者调研：summary, personas, pain_points 等  
- 内涵设计：每个方案的所有字段
- 内涵生产：所有字段模板内容
**解决**：统一编辑组件 + 后端保存API

### 问题4：备份系统
**需求**：修改上游时，下游版本需要备份
**解决**：项目版本控制机制

---

## 实施计划

### Phase 1：修复核心阻塞问题（404）

1. **添加 /select-scheme 端点**
   - 在 `workflow.py` 添加 `POST /{workflow_id}/select-scheme`
   - 接收 `scheme_index`
   - 更新 `content_core.selected_scheme_index`
   - 触发下一阶段

### Phase 2：修复调试日志

1. **确保AI调用设置上下文**
   - 在 `Orchestrator.run_stage` 开始时设置 `ai_client.set_context(project_id, stage)`
   - 检查所有模块是否正确使用

### Phase 3：重新设计内涵设计界面

1. **左右布局**
   - 左侧：方案列表（可折叠菜单）
   - 右侧：选中方案的完整详情（可编辑）
   
2. **编辑功能**
   - 每个字段可编辑
   - 保存按钮
   - 确认选择后进入下一阶段

### Phase 4：统一字段编辑系统

1. **通用编辑组件** `EditableField.tsx`
   - 支持文本、列表、对象
   - 编辑模式切换
   - 保存到后端

2. **后端API** `PATCH /workflow/{id}/update-field`
   - 更新任意阶段的任意字段
   - 验证权限和数据格式

### Phase 5：备份系统

1. **数据模型**
   - `ProjectVersion`: 项目某时刻的快照
   - `VersionTrigger`: 什么操作触发了版本创建

2. **机制**
   - 修改上游时检测是否有下游数据
   - 如果有，创建版本备份
   - 用户确认并可添加描述

---

## 测试基准

### Phase 1 测试
- [ ] 选择方案后成功进入下一阶段
- [ ] 无404错误

### Phase 2 测试
- [ ] 每次AI调用在调试日志中可见
- [ ] 显示正确的阶段名称

### Phase 3 测试
- [ ] 左侧目录点击切换方案
- [ ] 右侧显示完整可编辑内容
- [ ] 编辑保存成功

### Phase 4 测试
- [ ] 意图分析字段可编辑保存
- [ ] 消费者调研字段可编辑保存
- [ ] 内涵设计方案可编辑保存

### Phase 5 测试
- [ ] 修改意图后，有下游时触发备份提示
- [ ] 备份可在项目选择中查看

---

## TODO List

- [ ] 1.1 添加 `/select-scheme` 端点
- [ ] 1.2 修复前端 `selectScheme` 调用
- [ ] 1.3 测试方案选择流程

- [ ] 2.1 在 orchestrator 中设置 AI 上下文
- [ ] 2.2 测试调试日志显示

- [ ] 3.1 重写 CoreDesignStage 左右布局
- [ ] 3.2 添加方案编辑功能
- [ ] 3.3 测试交互流程

- [ ] 4.1 创建 EditableField 组件
- [ ] 4.2 添加 /update-field 端点
- [ ] 4.3 应用到所有阶段

- [ ] 5.1 设计 ProjectVersion 模型
- [ ] 5.2 实现版本创建逻辑
- [ ] 5.3 添加版本选择UI


