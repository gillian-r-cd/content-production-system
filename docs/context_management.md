# ä¸Šä¸‹æ–‡ç®¡ç†ä¸ä¸€è‡´æ€§ä¿éšœ
# åŠŸèƒ½ï¼šå®šä¹‰ä¸Šä¸‹æ–‡å¼•ç”¨æœºåˆ¶ã€åŸºç¡€å­—æ®µæ³¨å…¥ã€ä¸€è‡´æ€§æ£€æŸ¥
# æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•è®©Agentåœ¨å¯¹è¯ä¸­è½»æ¾å¼•ç”¨å„é˜¶æ®µå†…å®¹ï¼ŒåŒæ—¶ä¿è¯å…¨å±€ä¸€è‡´æ€§

---

## ä¸€ã€æ ¸å¿ƒé—®é¢˜

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ä¸Šä¸‹æ–‡ç®¡ç†

```yaml
é—®é¢˜1 - ä¿¡æ¯å­¤å²›:
  æ¯ä¸ªé˜¶æ®µç‹¬ç«‹ç”Ÿäº§ï¼Œå®¹æ˜“å‡ºç°ä¸ä¸€è‡´
  ä¾‹å¦‚ï¼šæ„å›¾è¯´"ç›®æ ‡æ˜¯æ–°æ‰‹"ï¼Œå†…æ¶µå´å†™æˆäº†ä¸“å®¶çº§å†…å®¹

é—®é¢˜2 - ä¸Šä¸‹æ–‡ä¸¢å¤±:
  LLMæ²¡æœ‰è®°å¿†ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½éœ€è¦é‡æ–°æ³¨å…¥ä¸Šä¸‹æ–‡
  å¦‚æœæ³¨å…¥ä¸å®Œæ•´ï¼Œè¾“å‡ºå°±ä¼šåç¦»

é—®é¢˜3 - å¼•ç”¨å›°éš¾:
  ç”¨æˆ·æƒ³è¯´"æŒ‰ç…§ä¹‹å‰å®šä¹‰çš„ç”¨æˆ·ç”»åƒæ¥å†™"
  ä½†Agentä¸çŸ¥é“"ä¹‹å‰å®šä¹‰"åœ¨å“ªé‡Œã€å†…å®¹æ˜¯ä»€ä¹ˆ
```

### 1.2 è®¾è®¡ç›®æ ‡

```yaml
ç›®æ ‡1: è½»æ¾å¼•ç”¨
  ç”¨æˆ·åœ¨å¯¹è¯ä¸­å¯ä»¥ç”¨ @é˜¶æ®µå æˆ– @å­—æ®µå å¼•ç”¨å·²æœ‰å†…å®¹
  Agentè‡ªåŠ¨è§£æå¹¶æ³¨å…¥åˆ°æç¤ºè¯

ç›®æ ‡2: è‡ªåŠ¨ä¸€è‡´æ€§
  æ¯æ¬¡ç”Ÿæˆéƒ½è‡ªåŠ¨æ³¨å…¥"åŸºç¡€å­—æ®µ"ï¼ˆæ ¸å¿ƒçº¦æŸï¼‰
  ä¸éœ€è¦ç”¨æˆ·æ¯æ¬¡éƒ½æé†’

ç›®æ ‡3: çµæ´»ç»„åˆ
  ç”¨æˆ·å¯ä»¥é€‰æ‹©å¼•ç”¨å“ªäº›ä¸Šä¸‹æ–‡
  ç³»ç»Ÿæ¨èä½†ä¸å¼ºåˆ¶
```

---

## äºŒã€ä¸Šä¸‹æ–‡å±‚çº§æ¨¡å‹

### 2.1 ä¸‰å±‚ä¸Šä¸‹æ–‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Layer 1: Golden Context                      â”‚
â”‚                    (æ¯æ¬¡è°ƒç”¨å¿…é¡»æ³¨å…¥)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ åˆ›ä½œè€…ç‰¹è´¨ (ç¦å¿Œã€èŒƒä¾‹ã€è‡ªå®šä¹‰å­—æ®µ)                        â”‚ â”‚
â”‚  â”‚ â€¢ æ ¸å¿ƒæ„å›¾ (ç›®æ ‡ã€æˆåŠŸæ ‡å‡†)                                  â”‚ â”‚
â”‚  â”‚ â€¢ ç›®æ ‡ç”¨æˆ·ç”»åƒ (ä»æ¶ˆè´¹è€…è°ƒç ”æå–çš„å…³é”®ä¿¡æ¯)                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Layer 2: Stage Context                       â”‚
â”‚                    (æŒ‰éœ€å¼•ç”¨ï¼ŒæŒ‰é˜¶æ®µç´¢å¼•)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ @æ„å›¾åˆ†æ â”‚ â”‚@æ¶ˆè´¹è€…è°ƒç ”â”‚ â”‚ @å†…æ¶µç”Ÿäº§ â”‚ â”‚ @å¤–å»¶ç”Ÿäº§ â”‚           â”‚
â”‚  â”‚ å®Œæ•´äº§å‡º  â”‚ â”‚ å®Œæ•´äº§å‡º  â”‚ â”‚ å„å­—æ®µå†…å®¹â”‚ â”‚ å„æ¸ é“å†…å®¹â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Layer 3: Field Context                       â”‚
â”‚                    (ç²¾ç¡®å¼•ç”¨ï¼ŒæŒ‰å­—æ®µç´¢å¼•)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚@è¯¾ç¨‹ç›®æ ‡  â”‚ â”‚ @è¯¾ç¨‹å¤§çº² â”‚ â”‚@ç¬¬ä¸€èŠ‚è„šæœ¬â”‚ â”‚@ä»‹ç»é¡µæ–‡æ¡ˆâ”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Golden Contextï¼ˆé»„é‡‘ä¸Šä¸‹æ–‡ï¼‰

**å®šä¹‰**ï¼šå¿…é¡»åœ¨æ¯æ¬¡LLMè°ƒç”¨ä¸­æ³¨å…¥çš„æ ¸å¿ƒä¿¡æ¯ï¼Œç¡®ä¿å…¨å±€ä¸€è‡´æ€§ã€‚

```yaml
GoldenContext:
  # ===== æ¥æºï¼šCreatorProfile =====
  creator_constraints:
    taboos: string[]              # ç¦å¿Œï¼ˆå¿…é¡»éµå®ˆï¼‰
    voice_examples: string[]      # èŒƒä¾‹æ–‡æœ¬ï¼ˆé£æ ¼å‚è€ƒï¼‰
    custom_fields: object         # ç”¨æˆ·å®šä¹‰çš„ç‰¹è´¨
  
  # ===== æ¥æºï¼šIntent =====
  core_intent:
    goal: string                  # ä¸€å¥è¯ç›®æ ‡
    success_criteria: string[]    # æˆåŠŸæ ‡å‡†
    must_have: string[]           # å¿…é¡»åŒ…å«
    must_avoid: string[]          # å¿…é¡»é¿å…
  
  # ===== æ¥æºï¼šConsumerResearchï¼ˆæå–å…³é”®ä¿¡æ¯ï¼‰=====
  target_user:
    persona_summary: string       # ä¸€å¥è¯ç”¨æˆ·ç”»åƒ
    key_pain_points: string[]     # æ ¸å¿ƒç—›ç‚¹
    key_desires: string[]         # æ ¸å¿ƒæœŸæœ›
```

**æ³¨å…¥æ¨¡æ¿**ï¼š

```markdown
## å…¨å±€çº¦æŸï¼ˆæ¯æ¬¡ç”Ÿæˆå¿…é¡»éµå®ˆï¼‰

### åˆ›ä½œè€…ç‰¹è´¨
{creator_constraints.custom_fields}

### ç¦å¿Œï¼ˆè¿åå³å¤±è´¥ï¼‰
- ç¦ç”¨è¯æ±‡ï¼š{creator_constraints.taboos}

### é£æ ¼å‚è€ƒ
{creator_constraints.voice_examples}

### æ ¸å¿ƒæ„å›¾
ç›®æ ‡ï¼š{core_intent.goal}
æˆåŠŸæ ‡å‡†ï¼š{core_intent.success_criteria}
å¿…é¡»åŒ…å«ï¼š{core_intent.must_have}
å¿…é¡»é¿å…ï¼š{core_intent.must_avoid}

### ç›®æ ‡ç”¨æˆ·
{target_user.persona_summary}
æ ¸å¿ƒç—›ç‚¹ï¼š{target_user.key_pain_points}
æ ¸å¿ƒæœŸæœ›ï¼š{target_user.key_desires}
```

### 2.3 Stage Contextï¼ˆé˜¶æ®µä¸Šä¸‹æ–‡ï¼‰

**å®šä¹‰**ï¼šæ¯ä¸ªé˜¶æ®µçš„å®Œæ•´äº§å‡ºï¼Œå¯æŒ‰éœ€å¼•ç”¨ã€‚

```yaml
StageContext:
  stages:
    intent:
      id: "intent"
      display_name: "æ„å›¾åˆ†æ"
      available: boolean          # æ˜¯å¦å·²å®Œæˆ
      content: Intent             # å®Œæ•´äº§å‡º
      summary: string             # æ‘˜è¦ï¼ˆç”¨äºå¿«é€Ÿé¢„è§ˆï¼‰
    
    consumer_research:
      id: "consumer_research"
      display_name: "æ¶ˆè´¹è€…è°ƒç ”"
      available: boolean
      content: ConsumerResearch
      summary: string
    
    content_core:
      id: "content_core"
      display_name: "å†…æ¶µç”Ÿäº§"
      available: boolean
      content: ContentCore
      summary: string
      # å†…æ¶µæœ‰å­å­—æ®µï¼Œå¯å•ç‹¬å¼•ç”¨
      fields:
        - name: "è¯¾ç¨‹ç›®æ ‡"
          available: boolean
          content: string
        - name: "è¯¾ç¨‹å¤§çº²"
          available: boolean
          content: string
        # ...
    
    content_extension:
      id: "content_extension"
      display_name: "å¤–å»¶ç”Ÿäº§"
      available: boolean
      channels:
        - name: "è¯¾ç¨‹ä»‹ç»é¡µ"
          available: boolean
          content: string
        - name: "å°çº¢ä¹¦"
          available: boolean
          content: string
        # ...
```

---

## ä¸‰ã€å¼•ç”¨æœºåˆ¶è®¾è®¡

### 3.1 å¼•ç”¨è¯­æ³•

```yaml
ç”¨æˆ·åœ¨å¯¹è¯ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯­æ³•å¼•ç”¨ä¸Šä¸‹æ–‡:

é˜¶æ®µçº§å¼•ç”¨:
  @æ„å›¾åˆ†æ          # å¼•ç”¨æ„å›¾åˆ†æçš„å®Œæ•´äº§å‡º
  @æ¶ˆè´¹è€…è°ƒç ”        # å¼•ç”¨æ¶ˆè´¹è€…è°ƒç ”çš„å®Œæ•´äº§å‡º
  @å†…æ¶µç”Ÿäº§          # å¼•ç”¨å†…æ¶µçš„æ‰€æœ‰å·²å®Œæˆå­—æ®µ

å­—æ®µçº§å¼•ç”¨ï¼ˆå†…æ¶µ/å¤–å»¶ï¼‰:
  @å†…æ¶µ.è¯¾ç¨‹ç›®æ ‡     # å¼•ç”¨å†…æ¶µä¸­çš„ç‰¹å®šå­—æ®µ
  @å†…æ¶µ.è¯¾ç¨‹å¤§çº²
  @å¤–å»¶.ä»‹ç»é¡µ

ç‰¹æ®Šå¼•ç”¨:
  @å…¨å±€çº¦æŸ          # æ˜¾å¼å¼•ç”¨Golden Context
  @åˆ›ä½œè€…ç‰¹è´¨        # åªå¼•ç”¨åˆ›ä½œè€…ç‰¹è´¨
  @ç”¨æˆ·ç”»åƒ          # åªå¼•ç”¨ç›®æ ‡ç”¨æˆ·ä¿¡æ¯
```

### 3.2 å¼•ç”¨è§£ææµç¨‹

```python
def parse_references(user_message: str, project_state: ProjectState) -> List[Reference]:
    """
    è§£æç”¨æˆ·æ¶ˆæ¯ä¸­çš„å¼•ç”¨
    
    ç¤ºä¾‹:
    ç”¨æˆ·: "æŒ‰ç…§ @ç”¨æˆ·ç”»åƒ çš„ç—›ç‚¹ï¼Œå¸®æˆ‘æ”¹å†™ @å†…æ¶µ.è¯¾ç¨‹ç›®æ ‡"
    
    è¿”å›:
    [
        Reference(type="golden", field="target_user", content="..."),
        Reference(type="field", stage="content_core", field="è¯¾ç¨‹ç›®æ ‡", content="...")
    ]
    """
    references = []
    
    # æ­£åˆ™åŒ¹é… @xxx æˆ– @xxx.yyy
    pattern = r'@([\u4e00-\u9fa5\w]+)(?:\.([\u4e00-\u9fa5\w]+))?'
    matches = re.findall(pattern, user_message)
    
    for stage_or_type, field in matches:
        if stage_or_type in GOLDEN_CONTEXT_ALIASES:
            # å¼•ç”¨é»„é‡‘ä¸Šä¸‹æ–‡çš„ä¸€éƒ¨åˆ†
            ref = resolve_golden_reference(stage_or_type, project_state)
        elif stage_or_type in STAGE_ALIASES:
            # å¼•ç”¨é˜¶æ®µ
            if field:
                ref = resolve_field_reference(stage_or_type, field, project_state)
            else:
                ref = resolve_stage_reference(stage_or_type, project_state)
        references.append(ref)
    
    return references
```

### 3.3 Agentå¼•ç”¨æç¤º

**åœ¨å¯¹è¯åŒºæ˜¾ç¤ºå¯ç”¨å¼•ç”¨**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯¹è¯                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  ğŸ¤– AI: å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ ä¿®æ”¹è¯¾ç¨‹ç›®æ ‡ã€‚      â”‚
â”‚                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ğŸ’¡ å¯å¼•ç”¨çš„ä¸Šä¸‹æ–‡ï¼š                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ @æ„å›¾åˆ†æ âœ“                      â”‚   â”‚
â”‚  â”‚ @æ¶ˆè´¹è€…è°ƒç ” âœ“                    â”‚   â”‚
â”‚  â”‚ @å†…æ¶µ.è¯¾ç¨‹ç›®æ ‡ âœ“                 â”‚   â”‚
â”‚  â”‚ @å†…æ¶µ.è¯¾ç¨‹å¤§çº² âœ“                 â”‚   â”‚
â”‚  â”‚ @å†…æ¶µ.ç¬¬ä¸€èŠ‚è„šæœ¬ â—‹ (æœªå®Œæˆ)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ è¯·æŒ‰ç…§ @ç”¨æˆ·ç”»åƒ æ”¹å†™...      [â†’]â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 æ™ºèƒ½å¼•ç”¨æ¨è

```yaml
å½“ç”¨æˆ·è¯·æ±‚æŸä¸ªä»»åŠ¡æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨æ¨èç›¸å…³å¼•ç”¨:

ç”¨æˆ·: "å¸®æˆ‘å†™è¯¾ç¨‹ä»‹ç»é¡µ"
ç³»ç»Ÿæ¨è:
  - @æ„å›¾åˆ†æï¼ˆæ˜ç¡®ç›®æ ‡ï¼‰
  - @ç”¨æˆ·ç”»åƒï¼ˆäº†è§£å—ä¼—ï¼‰
  - @å†…æ¶µ.è¯¾ç¨‹ç›®æ ‡ï¼ˆæå–å–ç‚¹ï¼‰
  - @å†…æ¶µ.è¯¾ç¨‹å¤§çº²ï¼ˆå±•ç¤ºå†…å®¹ï¼‰

æ¨èé€»è¾‘:
  æ ¹æ®ä»»åŠ¡ç±»å‹ï¼Œé¢„å®šä¹‰ç›¸å…³çš„å¼•ç”¨
  ç”¨æˆ·å¯ä»¥æ¥å—æ¨èï¼Œä¹Ÿå¯ä»¥è‡ªå·±é€‰æ‹©
```

---

## å››ã€ä¸€è‡´æ€§ä¿éšœæœºåˆ¶

### 4.1 é—®é¢˜ï¼šä¸ºä»€ä¹ˆä¼šä¸ä¸€è‡´

```yaml
åŸå› 1: ä¸Šä¸‹æ–‡é—æ¼
  ç”Ÿæˆå†…æ¶µæ—¶å¿˜è®°æ³¨å…¥ç›®æ ‡ç”¨æˆ·ä¿¡æ¯
  â†’ å†…å®¹åç¦»ç”¨æˆ·éœ€æ±‚

åŸå› 2: ä¿¡æ¯å†²çª
  æ„å›¾è¯´"è½»æ¾å¹½é»˜"ï¼Œæ¶ˆè´¹è€…è°ƒç ”è¯´"ç”¨æˆ·å–œæ¬¢ä¸“ä¸šä¸¥è°¨"
  â†’ ç”Ÿæˆå†…å®¹é£æ ¼æ··ä¹±

åŸå› 3: è¿­ä»£é—å¿˜
  ç¬¬3æ¬¡è¿­ä»£æ—¶ï¼Œå¿˜è®°ç¬¬1æ¬¡ç¡®å®šçš„æ ¸å¿ƒä¿¡æ¯
  â†’ å†…å®¹è¶Šæ”¹è¶Šå
```

### 4.2 è§£å†³æ–¹æ¡ˆï¼šåˆ†å±‚æ³¨å…¥ + ä¸€è‡´æ€§æ£€æŸ¥

#### 4.2.1 åˆ†å±‚æ³¨å…¥ç­–ç•¥

```yaml
æ¯æ¬¡LLMè°ƒç”¨çš„Promptç»“æ„:

1. Golden Contextï¼ˆå¿…æ³¨å…¥ï¼‰
   â””â”€ åˆ›ä½œè€…ç‰¹è´¨ + æ ¸å¿ƒæ„å›¾ + ç›®æ ‡ç”¨æˆ·æ‘˜è¦

2. ä»»åŠ¡ç›¸å…³ä¸Šä¸‹æ–‡ï¼ˆæŒ‰éœ€æ³¨å…¥ï¼‰
   â””â”€ ç”¨æˆ·æ˜¾å¼å¼•ç”¨çš„ @xxx
   â””â”€ ç³»ç»Ÿæ¨èçš„ç›¸å…³å¼•ç”¨

3. å½“å‰ä»»åŠ¡æè¿°
   â””â”€ å…·ä½“è¦åšä»€ä¹ˆ

4. è¾“å‡ºè¦æ±‚
   â””â”€ æ ¼å¼ã€é•¿åº¦ã€é£æ ¼çº¦æŸ
```

#### 4.2.2 ä¸€è‡´æ€§æ£€æŸ¥ç‚¹

```yaml
æ£€æŸ¥æ—¶æœº:
  - æ¯ä¸ªå­—æ®µç”Ÿæˆå
  - é˜¶æ®µå®Œæˆæ—¶
  - ç”¨æˆ·è¯·æ±‚æ£€æŸ¥æ—¶

æ£€æŸ¥å†…å®¹:
  1. ç¦å¿Œè¯æ£€æŸ¥:
     æ‰«æç”Ÿæˆå†…å®¹ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«ç¦å¿Œè¯
     
  2. é£æ ¼ä¸€è‡´æ€§æ£€æŸ¥:
     ç”¨Simulatoræ£€æŸ¥æ˜¯å¦"åƒåˆ›ä½œè€…çš„é£æ ¼"
     
  3. æ„å›¾å¯¹é½æ£€æŸ¥:
     æ£€æŸ¥å†…å®¹æ˜¯å¦ç¬¦åˆæ ¸å¿ƒæ„å›¾
     
  4. ç”¨æˆ·ç”»åƒåŒ¹é…æ£€æŸ¥:
     æ£€æŸ¥å†…å®¹æ˜¯å¦é€‚åˆç›®æ ‡ç”¨æˆ·
```

#### 4.2.3 ä¸€è‡´æ€§æ£€æŸ¥Promptæ¨¡æ¿

```markdown
## ä¸€è‡´æ€§æ£€æŸ¥ä»»åŠ¡

è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹æ˜¯å¦ä¸åŸºç¡€çº¦æŸä¸€è‡´ã€‚

### åŸºç¡€çº¦æŸ
{golden_context}

### å¾…æ£€æŸ¥å†…å®¹
{content}

### æ£€æŸ¥é¡¹
1. æ˜¯å¦åŒ…å«ç¦å¿Œè¯ï¼Ÿå¦‚æœ‰ï¼Œåˆ—å‡ºå…·ä½“ä½ç½®ã€‚
2. é£æ ¼æ˜¯å¦åƒåˆ›ä½œè€…çš„é£æ ¼ï¼Ÿ(1-10åˆ†)
3. æ˜¯å¦ç¬¦åˆæ ¸å¿ƒæ„å›¾"{core_intent.goal}"ï¼Ÿ(1-10åˆ†)
4. æ˜¯å¦é€‚åˆç›®æ ‡ç”¨æˆ·"{target_user.persona_summary}"ï¼Ÿ(1-10åˆ†)

### è¾“å‡ºæ ¼å¼
```yaml
consistency_check:
  taboo_violations: []
  style_score: number
  intent_alignment: number
  user_fit: number
  issues: []
  suggestions: []
```
```

---

## äº”ã€ç³»ç»Ÿæç¤ºè¯æ¶æ„

### 5.1 æç¤ºè¯ç»„æˆç»“æ„

æ¯ä¸ªé˜¶æ®µçš„ç³»ç»Ÿæç¤ºè¯éƒ½éµå¾ªç»Ÿä¸€ç»“æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     System Prompt ç»“æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  [Part 1] Golden Context Injection                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  {è‡ªåŠ¨æ³¨å…¥ï¼Œç”¨æˆ·æ— éœ€å…³å¿ƒ}                                        â”‚
â”‚                                                                 â”‚
â”‚  [Part 2] Stage-Specific Role                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ä½ æ˜¯ä¸€ä¸ª{è§’è‰²}ï¼Œæ­£åœ¨è¿›è¡Œ{é˜¶æ®µ}ä»»åŠ¡ã€‚                            â”‚
â”‚  {è¯¥é˜¶æ®µçš„èƒ½åŠ›è¾¹ç•Œ}                                              â”‚
â”‚                                                                 â”‚
â”‚  [Part 3] Referenced Context                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  {ç”¨æˆ·å¼•ç”¨çš„ä¸Šä¸‹æ–‡ï¼ŒåŠ¨æ€æ³¨å…¥}                                    â”‚
â”‚                                                                 â”‚
â”‚  [Part 4] Task Description                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  {å½“å‰å…·ä½“ä»»åŠ¡ï¼Œæ¥è‡ªç”¨æˆ·è¾“å…¥}                                    â”‚
â”‚                                                                 â”‚
â”‚  [Part 5] Output Requirements                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  {è¾“å‡ºæ ¼å¼ã€é•¿åº¦ã€ç»“æ„è¦æ±‚}                                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Golden Context æ³¨å…¥æ¨¡æ¿ï¼ˆè‡ªåŠ¨ï¼‰

```python
def build_golden_context_prompt(project: Project) -> str:
    """æ„å»ºé»„é‡‘ä¸Šä¸‹æ–‡çš„Promptç‰‡æ®µ"""
    
    return f"""
## å…¨å±€çº¦æŸï¼ˆæ¯æ¬¡ç”Ÿæˆå¿…é¡»éµå®ˆï¼Œä¸å¯è¿åï¼‰

### åˆ›ä½œè€…èº«ä»½
{format_creator_profile(project.creator_profile)}

### ç¦å¿Œäº‹é¡¹
ä»¥ä¸‹å†…å®¹ç»å¯¹ä¸èƒ½å‡ºç°åœ¨è¾“å‡ºä¸­ï¼š
- ç¦ç”¨è¯æ±‡ï¼š{', '.join(project.creator_profile.taboos.forbidden_words)}
- ç¦ç¢°è¯é¢˜ï¼š{', '.join(project.creator_profile.taboos.forbidden_topics)}

### æ ¸å¿ƒæ„å›¾
- ç›®æ ‡ï¼š{project.intent.goal}
- æˆåŠŸæ ‡å‡†ï¼š{format_list(project.intent.success_criteria)}
- å¿…é¡»åŒ…å«ï¼š{format_list(project.intent.must_have)}
- å¿…é¡»é¿å…ï¼š{format_list(project.intent.must_avoid)}

### ç›®æ ‡ç”¨æˆ·
{project.consumer_research.summary or "æš‚æœªå®šä¹‰ï¼Œè¯·æ ¹æ®æ„å›¾æ¨æ–­"}

### é£æ ¼å‚è€ƒ
ä»¥ä¸‹æ˜¯åˆ›ä½œè€…çš„å…¸å‹æ–‡æœ¬ï¼Œè¯·æ¨¡ä»¿å…¶é£æ ¼ï¼š
---
{project.creator_profile.example_texts[0] if project.creator_profile.example_texts else "æš‚æ— èŒƒä¾‹"}
---
"""
```

### 5.3 å„é˜¶æ®µçš„æç¤ºè¯æ¨¡æ¿

#### æ„å›¾åˆ†æé˜¶æ®µ

```python
def build_intent_analysis_prompt(golden_context: str, user_input: str) -> str:
    return f"""
{golden_context}

## å½“å‰ä»»åŠ¡ï¼šæ„å›¾åˆ†æ

ä½ æ˜¯ä¸€ä¸ªæ„å›¾åˆ†æä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä»ç”¨æˆ·çš„æè¿°ä¸­æå–ç»“æ„åŒ–çš„å†…å®¹ç”Ÿäº§æ„å›¾ã€‚

### èƒ½åŠ›è¾¹ç•Œ
- âœ… ä½ æ“…é•¿ï¼šè¿½é—®æ¾„æ¸…ã€å½’çº³æ€»ç»“ã€è¯†åˆ«éšå«éœ€æ±‚
- âŒ ä½ ä¸åšï¼šç”Ÿäº§å†…å®¹ã€è¯„åˆ¤å¯¹é”™

### ç”¨æˆ·è¾“å…¥
{user_input}

### è¾“å‡ºè¦æ±‚
è¾“å‡ºç»“æ„åŒ–çš„æ„å›¾åˆ†æç»“æœï¼ˆYAMLæ ¼å¼ï¼‰ã€‚
å¦‚æœä¿¡æ¯ä¸å®Œæ•´ï¼Œå…ˆè¿½é—®ã€‚
"""
```

#### å†…æ¶µç”Ÿäº§é˜¶æ®µ

```python
def build_content_core_prompt(
    golden_context: str, 
    field_name: str,
    field_description: str,
    field_ai_hint: str,
    referenced_context: str,
    previous_fields: dict
) -> str:
    return f"""
{golden_context}

## å½“å‰ä»»åŠ¡ï¼šå†…æ¶µç”Ÿäº§ - {field_name}

### å·²å®Œæˆçš„å­—æ®µ
{format_previous_fields(previous_fields)}

### å¼•ç”¨çš„ä¸Šä¸‹æ–‡
{referenced_context}

### å½“å‰å­—æ®µ
- åç§°ï¼š{field_name}
- è¯´æ˜ï¼š{field_description}
- æç¤ºï¼š{field_ai_hint}

### è¾“å‡ºè¦æ±‚
ç”Ÿæˆè¯¥å­—æ®µçš„å®Œæ•´å†…å®¹ã€‚
å¿…é¡»ä¸å·²å®Œæˆçš„å­—æ®µä¿æŒä¸€è‡´ã€‚
å¿…é¡»ç¬¦åˆå…¨å±€çº¦æŸä¸­çš„é£æ ¼å’Œç¦å¿Œã€‚
"""
```

#### å¤–å»¶ç”Ÿäº§é˜¶æ®µ

```python
def build_extension_prompt(
    golden_context: str,
    channel_name: str,
    channel_constraints: dict,
    available_core_content: dict,
    referenced_context: str
) -> str:
    return f"""
{golden_context}

## å½“å‰ä»»åŠ¡ï¼šå¤–å»¶ç”Ÿäº§ - {channel_name}

### å¯ç”¨çš„å†…æ¶µç´ æ
{format_available_content(available_core_content)}

### å¼•ç”¨çš„ä¸Šä¸‹æ–‡
{referenced_context}

### æ¸ é“è¦æ±‚
- æ¸ é“ï¼š{channel_name}
- æ ¼å¼çº¦æŸï¼š{format_constraints(channel_constraints)}

### è¾“å‡ºè¦æ±‚
åŸºäºå†…æ¶µç´ æå’Œå…¨å±€çº¦æŸï¼Œç”Ÿæˆé€‚åˆè¯¥æ¸ é“çš„è¥é”€å†…å®¹ã€‚
å³ä½¿å†…æ¶µæœªå®Œæˆï¼Œä¹Ÿå¯ä»¥åŸºäºæ„å›¾å’Œç”¨æˆ·ç”»åƒç”Ÿæˆåˆç‰ˆã€‚
"""
```

---

## å…­ã€ä¸Šä¸‹æ–‡çª—å£ç®¡ç†

### 6.1 é—®é¢˜ï¼šä¸Šä¸‹æ–‡å¤ªé•¿æ€ä¹ˆåŠ

```yaml
åœºæ™¯:
  åˆ›ä½œè€…ç‰¹è´¨ï¼š1000 tokens
  æ„å›¾åˆ†æï¼š500 tokens
  æ¶ˆè´¹è€…è°ƒç ”ï¼š800 tokens
  å†…æ¶µå·²å®Œæˆ5ä¸ªå­—æ®µï¼š5000 tokens
  å½“å‰ä»»åŠ¡ï¼š500 tokens
  
  æ€»è®¡ï¼š7800 tokensï¼ˆè¿˜æ²¡ç®—è¾“å‡ºï¼‰
  
å¦‚æœæ¨¡å‹ä¸Šä¸‹æ–‡çª—å£æœ‰é™ï¼Œå¯èƒ½æ”¾ä¸ä¸‹
```

### 6.2 è§£å†³æ–¹æ¡ˆï¼šæ‘˜è¦ + æŒ‰éœ€åŠ è½½

```yaml
ç­–ç•¥1: å±‚çº§æ‘˜è¦
  æ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œç”Ÿæˆæ‘˜è¦
  å¼•ç”¨æ—¶å…ˆç»™æ‘˜è¦ï¼Œç”¨æˆ·éœ€è¦æ—¶å†ç»™å…¨æ–‡
  
ç­–ç•¥2: æŒ‰éœ€åŠ è½½
  ç”¨æˆ·æ˜¾å¼ @å¼•ç”¨ æ—¶æ‰åŠ è½½å®Œæ•´å†…å®¹
  æœªå¼•ç”¨çš„åªä¿ç•™æ‘˜è¦
  
ç­–ç•¥3: æ»‘åŠ¨çª—å£
  ä¿ç•™æœ€ç›¸å…³çš„å†…å®¹
  å†å²å†…å®¹åªä¿ç•™æ‘˜è¦
```

### 6.3 æ‘˜è¦ç”Ÿæˆ

```python
def generate_stage_summary(stage_content: dict, max_tokens: int = 200) -> str:
    """ä¸ºé˜¶æ®µå†…å®¹ç”Ÿæˆæ‘˜è¦"""
    
    prompt = f"""
    è¯·ç”¨ä¸è¶…è¿‡{max_tokens}ä¸ªtokenæ¦‚æ‹¬ä»¥ä¸‹å†…å®¹çš„æ ¸å¿ƒä¿¡æ¯ï¼š
    
    {stage_content}
    
    è¦æ±‚ï¼š
    1. ä¿ç•™æœ€å…³é”®çš„ä¿¡æ¯ç‚¹
    2. å¯ä»¥ç”¨äºåç»­é˜¶æ®µçš„å‚è€ƒ
    3. ç®€æ´ä½†ä¸é—æ¼æ ¸å¿ƒ
    """
    
    return llm.invoke(prompt)
```

---

## ä¸ƒã€æ•°æ®ç»“æ„æ›´æ–°

### 7.1 ProjectStateï¼ˆé¡¹ç›®çŠ¶æ€ï¼‰

```yaml
ProjectState:
  project_id: string
  
  # ===== Golden Contextï¼ˆå®æ—¶è®¡ç®—ï¼‰=====
  golden_context:
    creator_constraints: object   # ä»CreatorProfileæå–
    core_intent: object           # ä»Intentæå–
    target_user: object           # ä»ConsumerResearchæå–
  
  # ===== Stage Contexts =====
  stages:
    intent:
      status: "pending" | "completed"
      content: Intent | null
      summary: string | null
    
    consumer_research:
      status: "pending" | "completed" | "skipped"
      content: ConsumerResearch | null
      summary: string | null
    
    content_core:
      status: "pending" | "in_progress" | "completed"
      selected_approach: object | null
      fields:
        - name: string
          status: "pending" | "completed"
          content: string | null
          summary: string | null
    
    content_extension:
      channels:
        - name: string
          status: "pending" | "completed"
          content: string | null
  
  # ===== å¼•ç”¨ç´¢å¼•ï¼ˆå¿«é€ŸæŸ¥æ‰¾ï¼‰=====
  reference_index:
    "@æ„å›¾åˆ†æ": { available: true, path: "stages.intent" }
    "@æ¶ˆè´¹è€…è°ƒç ”": { available: true, path: "stages.consumer_research" }
    "@å†…æ¶µ.è¯¾ç¨‹ç›®æ ‡": { available: true, path: "stages.content_core.fields[0]" }
    # ...
```

---

## å…«ã€å®ç°ä¼˜å…ˆçº§

### P0ï¼šæ ¸å¿ƒæœºåˆ¶
1. Golden Context è‡ªåŠ¨æ³¨å…¥
2. åŸºç¡€çš„ @é˜¶æ®µ å¼•ç”¨è§£æ
3. ç¦å¿Œè¯æ£€æŸ¥

### P1ï¼šå¢å¼ºåŠŸèƒ½
1. @å­—æ®µ çº§åˆ«çš„ç²¾ç¡®å¼•ç”¨
2. å¼•ç”¨æ¨è
3. ä¸€è‡´æ€§æ£€æŸ¥Simulator

### P2ï¼šä¼˜åŒ–ä½“éªŒ
1. ä¸Šä¸‹æ–‡çª—å£ç®¡ç†ï¼ˆæ‘˜è¦ï¼‰
2. å¼•ç”¨é¢„è§ˆ
3. ä¸€è‡´æ€§é—®é¢˜è‡ªåŠ¨ä¿®å¤å»ºè®®



